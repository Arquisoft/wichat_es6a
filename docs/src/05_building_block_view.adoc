ifndef::imagesdir[:imagesdir: ../images]
:icons: font

[[section-building-block-view]]
== Building Block View

---
This view shows the static decomposition of the WIChat system into its main building blocks (components, services) and outlines their responsibilities and primary relationships.

=== High-Level System Overview (Context Recap)

---
The following diagram shows the WIChat system as a whole (blackbox), interacting with the primary user and external data/service providers (Wikidata, LLM).

image::BuildingBlockViewFirst.png["High-Level Context Diagram", align="center"]

=== Whitebox Overall System (Level 1)

---
This section describes the top-level decomposition of the WIChat trivia game system into its internal microservices and components.

==== Overview Diagram (Level 1)

---
The following diagram shows the main internal building blocks (Level 1) of the WIChat system and their primary interactions.

image::BuildingBlockView2.png["Level 1 Whitebox Diagram for WIChat System", align="center"]

==== Motivation

---
El sistema WIChat se descompone en microservicios (Level 1) para:

* **Separation of Concerns:** UI (`WebApp`), routing/agrupación (`Gateway Service`), gestión de usuarios (`Users Service`), autenticación (`Auth Service`), lógica de preguntas (`Question Service`), historial/estadísticas (`History Service`), interacción/caché con Wikidata (`Wikidata Service`), sugerencias IA (`LLM Service`).
* **Independent Scalability:** Escalar cada servicio según demanda (ej. `Question Service` durante el juego, `Auth Service` en picos de inicio de sesión).
* **Technological Flexibility:** Permite distintas tecnologías por servicio y actualizaciones independientes.
* **Maintainability & Testability:** Servicios más pequeños son más fáciles de gestionar, probar y desplegar.
* **Resilience:** Fallos en servicios no críticos (ej. `LLM Service`) afectan mínimamente la jugabilidad.

==== Level 1 Building Blocks (Blackboxes)

---
===== `WebApp` (Frontend)
*Responsibility*:: Proporciona la interfaz web interactiva. Muestra preguntas, respuestas, imágenes, puntuación, estadísticas y perfil de usuario. Comunica únicamente con el `Gateway Service`.  
*Interfaces (Consumed)*:: Gateway API (REST/WebSocket).

---
===== `Gateway Service`
*Responsibility*:: Punto de entrada único. Enruta peticiones a microservicios (`Auth`, `Users`, `Questions`, `History`, `LLM`, `Wikidata`), gestiona CORS, validación básica, expone Swagger y métricas (Prometheus), verifica estado de downstream services.  
*Interfaces*::  
* *Provided:* Gateway API (REST), `/metrics`, `/health`, `/api-doc`.  
* *Consumed:* APIs de Auth, Users, Question, History, LLM, Wikidata.  
*Technology*:: Node.js, Express, Axios.

---
===== `Auth Service`
*Responsibility*:: Autenticación de usuarios (validación y emisión de tokens JWT).  
*Interfaces*::  
* *Provided:* `/login` (REST).  
* *Consumed:* Users Service o acceso directo a base de datos.  
*Technology*:: Node.js/Express.

---
===== `Users Service`
*Responsibility*:: CRUD de usuarios, gestión de avatar.  
*Interfaces*::  
* *Provided:* `/addUser`, `/user/{id}` (REST).  
* *Consumed:* Base de datos.  
*Technology*:: Node.js/Express.

---
===== `Question Service`
*Responsibility*:: Almacenamiento y recuperación de preguntas generadas.  
*Interfaces*::  
* *Provided:* `/addQuestion`, `/questions` (REST).  
* *Consumed:* Base de datos.

---
===== `History Service`
*Responsibility*:: Persiste historial de juegos y calcula estadísticas agregadas.  
*Interfaces*::  
* *Provided:* `/addGame`, `/stats`, `/getBestGames`, `/getAllGames`.  
* *Consumed:* Base de datos (Mongoose).  
*Technology*:: Node.js, Express, Mongoose.

---
===== `Wikidata Service`
*Responsibility*:: Fachada y caché para Wikidata. Consulta SPARQL, procesa y almacena en caché.  
*Interfaces*::  
* *Provided:* `/api/entries/{…}`.  
* *Consumed:* Wikidata SPARQL y base de datos (Mongoose).

---
===== `LLM Service` (Hint Service)
*Responsibility*:: Orquesta generación de preguntas y sugerencias. Obtiene datos base de Wikidata, llama al LLM externo, formatea y persiste preguntas.  
*Interfaces*::  
* *Provided:* `/generateQuestions`, `/getHint`, `/getHintWithQuery`.  
* *Consumed:* Gateway → Wikidata Service, LLM API externo, Gateway → Question Service.  
*Technology*:: Node.js, Express, Axios, @google/genai.

---
===== `Database`
*Responsibility*:: Almacena persistente: usuarios, historial, preguntas, caché de Wikidata.  
*Interfaces*:: Driver de MongoDB consumido por servicios.  
*Technology*:: MongoDB.

=== Important Interfaces (Summary)

---
[.text-center]
_Summary de interfaces clave._

[cols="^1,3m,^1,^2", options="header"]
|===
| Interface Name         | Description                                                    | Provided By        | Consumed By
| Gateway API (REST)     | API para WebApp (auth, juego, sugerencias, perfil, stats, proxy). | Gateway Service    | WebApp
| Auth Service API       | API interna para login/token.                                   | Auth Service       | Gateway Service
| Users Service API      | CRUD de usuarios.                                               | Users Service      | Gateway Service, Auth Service
| Question Service API   | Guardar/recuperar preguntas.                                    | Question Service   | Gateway Service (y LLM Service)
| History Service API    | Guardar resultados y stats.                                     | History Service    | Gateway Service
| Wikidata Service API   | Datos procesados de Wikidata.                                   | Wikidata Service   | Gateway Service (y LLM Service)
| LLM Service API        | Generación de preguntas y sugerencias.                          | LLM Service        | Gateway Service
| Database Access        | Interface de consulta de MongoDB.                               | Database           | Todos los servicios
| Wikidata SPARQL        | Endpoint externo para datos brutos.                             | Wikidata (External)| Wikidata Service
| External LLM API       | Proveedor de IA para texto.                                     | LLM Provider       | LLM Service
|===

[[level2-refinements]]
== Level 2 (Refinements)

---
=== White Box LLM Service (Hint Service)

==== Motivation (LLM Service Focus)

---
Este servicio encapsula la lógica compleja de interacción con proveedores externos (LLM, Wikidata Service) y coordina múltiples pasos para generar preguntas y sugerencias.

==== Internal Logic Flow / Responsibilities

===== Question Generation Orchestration (`/generateQuestions` endpoint)

---
image::BuildingBlockViewGenerateQuestions.png["Generation Questions Flow Diagram", align="center"]

1. Recibe categoría y número de preguntas del Gateway Service.  
2. Solicita datos base (incluyendo `imageUrl`) al Wikidata Service vía Gateway.  
3. Para cada entrada:  
   * Formatea la información textual (`formatEntryInfo`).  
   * Construye un prompt detallado para el LLM externo (Gemini/Empathy).  
   * Llama al API del LLM externo (`sendQuestionToLLM`).  
   * Parsea y valida la respuesta JSON (`parseJsonResponse`), reintentando si es necesario.  
   * Combina el texto generado con el `imageUrl`.  
   * Persiste la pregunta mediante el endpoint `/addQuestion` del Gateway.  
4. Agrega todas las preguntas generadas y las devuelve al Gateway Service.

---
===== Hint Generation (`/getHint` endpoint)

---
image::BuildingBlockViewHintRequest.png["Get Hint Flow Diagram", align="center"]

1. Recibe el texto de la pregunta y opciones de respuesta del Gateway Service.  
2. Construye un prompt que solicite una pista sin revelar la respuesta correcta.  
3. Llama al API del LLM externo y parsea la respuesta.  
4. Devuelve una única oración como pista.

---
===== Conversational Hint Generation (`/getHintWithQuery` endpoint)

---
1. Similar a `/getHint`, pero incorpora una consulta específica del usuario.  
2. Filtra para prevenir revelaciones directas de la respuesta.  
3. Construye y envía el prompt al LLM, parsea y retorna la pista conversacional.

[[level3-concepts]]
== Level 3 (Refinements / Concepts)

---
=== Concept: Question Generation and Storage Flow

**Componentes involucrados:** Gateway Service, LLM Service, Wikidata Service, Question Service, Database, Wikidata SPARQL, LLM Externo.

1. WebApp solicita preguntas por categoría al Gateway.  
2. Gateway enruta a LLM Service (`/generateQuestions`).  
3. LLM Service pide datos base al Wikidata Service vía Gateway.  
4. Wikidata Service devuelve datos cacheados.  
5. LLM Service formatea y envía prompt al LLM externo.  
6. LLM responde en JSON; LLM Service parsea y valida.  
7. LLM Service unifica texto e imagen, y llama `/addQuestion` vía Gateway.  
8. Gateway enruta a Question Service, que guarda en la base de datos.  
9. LLM Service retorna las preguntas al llamador original.

---
=== Concept: Statistics Calculation

**Componente responsable:** History Service

Cuando se llama a `/stats`:
* Recupera todos los registros de juegos del usuario.  
* Calcula en memoria estadísticas agregadas (puntos totales, número de juegos, ratio victoria/derrota, medias, categoría más jugada).  
* Devuelve resultados, incluyendo las 3 partidas más destacadas.

> ⚠️ Para usuarios con historiales muy extensos, el rendimiento podría verse afectado al cargar y procesar todos los registros en memoria.
